rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -- Helpers
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.admin == true ||
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
      );
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // -- Users
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();

      match /notifications/{notificationId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
    }

    // -- Matches
    match /matches/{matchId} {
      allow read, write: if isAdmin() ||
                         (request.auth != null &&
                         resource != null &&
                         (resource.data.users[0] == request.auth.uid ||
                          resource.data.users[1] == request.auth.uid));
    }

    // -- Dates
    match /dates/{dateId} {
      allow read, write: if isAdmin() ||
                         (request.auth != null &&
                          resource != null &&
                         (resource.data.users[0] == request.auth.uid ||
                          resource.data.users[1] == request.auth.uid));
    }

    // -- Messages
    match /messages/{messageId} {
      allow read: if isAdmin() ||
                  (request.auth != null &&
                   resource != null &&
                   (resource.data.fromUid == request.auth.uid ||
                    resource.data.toUid == request.auth.uid));

      allow create: if isAdmin() ||
                    (request.auth != null &&
                     request.resource.data.fromUid == request.auth.uid);

      allow update: if isAdmin() ||
                    (request.auth != null &&
                     resource != null &&
                     resource.data.toUid == request.auth.uid &&
                     request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['read']));
    }

    // -- Reports
    match /reports/{reportId} {
      allow create: if request.auth != null &&
                    request.resource.data.reporterId == request.auth.uid;

      allow read, write: if isAdmin() ||
                         (request.auth != null &&
                          resource != null &&
                          resource.data.reporterId == request.auth.uid);
    }

    // -- Admin-only collections
    match /admins/{docId} {
      allow read, write: if isAdmin();
    }
    match /analytics/{docId} {
      allow read, write: if isAdmin();
    }
    match /settings/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    match /verifications/{docId} {
      allow read, write: if isOwner(docId) || isAdmin();
    }
    match /queue/{docId} {
      allow read, write: if isOwner(docId) || isAdmin();
    }

    // -- Global fallback for admins
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
